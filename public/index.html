<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="KIEAN_LOGO_Icon.png" type="image/png" />
    <title>Kiean Tutorial Center Attendance</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }

      video {
        border: 10px solid rgb(248, 248, 248);
        width: 320px;
        height: 240px;
        margin-top: 0px;
        transition: border-color 0.3s ease;
      }

      #status {
        margin-top: 10px;
        font-weight: bold;
      }

      #qr-content {
        margin-top: 10px;
        color: rgb(230, 17, 17);
        font-weight: bold;
      }

      #esp-ip {
        margin-top: 10px;
        padding: 5px;
        width: 150px;
      }

      label {
        font-weight: bold;
      }
    </style>

    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <div class="main-content">
      <div class="top-div"></div>

      <div class="qrArea">
        <video id="video" autoplay></video>
        <canvas id="canvas" hidden></canvas>
      </div>

      <div id="studentname"></div>
      <div id="status">Initializing camera...</div>
    </div>

    <script src="jsQR.js"></script>
    <script type="module">
      import { processQRCodeData } from "./processQR.js";
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      window.onload = async () => {
        // ---- SUPABASE SETUP ----
        const SUPABASE_URL = "https://woqvutbipzimgwicwxzx.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvcXZ1dGJpcHppbWd3aWN3eHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjEwOTcsImV4cCI6MjA3NjEzNzA5N30.DgQyMKQ2C1e6hg9XOjrMkJJ7lqL7r1aJZV50ZoOmj7k";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const TABLE_NAME = "attendance";

        // ---- ELEMENTS ----
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const statusEl = document.getElementById("status");
        const studentname = document.getElementById("studentname");

        // ---- SOUNDS ----
        const successSound = new Audio("./beepsound.mp3");
        const warnBeep = new Audio("./warnbeep.mp3");

        // ---- SETTINGS ----
        let lastSentQR = "";
        let isScanningPaused = false;
        const SCAN_PAUSE_MS = 1000;

        // ---- CAMERA ----
        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            video.srcObject = stream;
            statusEl.textContent = "Scan a QR code.";
          })
          .catch((err) => {
            console.error(err);
            statusEl.textContent = "Camera access denied!";
          });

        // ---- MAIN LOOP ----
        video.addEventListener("play", () => {
          const scanLoop = () => {
            if (video.paused || video.ended) return;
            if (!isScanningPaused) {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              const imageData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height,
                { willReadFrequently: true } // optional perf boost
              );
              const code = jsQR(imageData.data, canvas.width, canvas.height);

              if (code && code.data) {
                const qrData = code.data.trim();
                if (qrData !== lastSentQR) {
                  lastSentQR = qrData;
                  handleScan(qrData);
                }
              }
            }
            requestAnimationFrame(scanLoop);
          };
          scanLoop();
        });

        // ---- HANDLE QR SCAN ----
        async function handleScan(qrData) {
          try {
            const parts = processQRCodeData(qrData);
            const [
              studentId,
              firstName,
              middleName,
              lastName,
              studentlevel,
              branchlocation,
              mobilenum,
            ] = parts;

            const fullName = `${firstName} ${middleName} ${lastName}`.trim();

            // ðŸŸ¢ Fetch last attendance record
            const { data: existing, error: fetchError } = await supabase
              .from(TABLE_NAME)
              .select("time_in, in_out")
              .eq("StudentID", studentId)
              .order("time_in", { ascending: false })
              .limit(1);

            if (fetchError) throw fetchError;

            let action = "time-in";
            let message = "TIME IN recorded";
            let statusColor = "green";

            if (existing && existing.length > 0) {
              const lastRecord = existing[0];

              const timestamp =lastRecord.time_in; // e.g., "2025-10-24T13:22:50+08:00"

              // Step 1: Remove the timezone part by splitting at '+'
              const mainPart = timestamp.split("+")[0]; // "2025-10-24T13:22:50"

              // Step 2: Split date and time
              const dateTimeParts = mainPart.split("T"); // ["2025-10-24", "13:22:50"]

              // Step 3: Extract the time portion
              const timePart = dateTimeParts[1]; // "13:22:50"

              // Step 4: Split into hours, minutes, seconds
              const [hours, minutes, seconds] = timePart.split(":").map(Number);

              // Step 5: Convert total time to seconds since midnight (optional)
              const Lasttime_totalSeconds = hours * 3600 + minutes * 60 + seconds;
            
             // Current UTC time
              const nowUTC = new Date();

              // Convert to PH timezone (UTC+8)
              const nowPH = new Date(nowUTC.getTime()+0 * 60 * 60 * 1000);

              // If you want total seconds since midnight for interval calculation
              const totalSeconds = nowPH.getHours() * 3600 + nowPH.getMinutes() * 60 + nowPH.getSeconds();
              
              const diffMins = Math.floor((totalSeconds - Lasttime_totalSeconds) / 60);


              if (diffMins < 5) {
                console.log("Please wait before scanning again.");
                message = `Please wait ${Math.ceil(5 - diffMins)} minute(s) before scanning again.`;
                statusColor = "orange";
                warnBeep.play();
                showMessage(fullName, message, statusColor);
                resumeScanning();
                return;
              }

              // Determine action type
              if (lastRecord.in_out === "time-in") {
                action = "time-out";
                message = "TIME OUT recorded";
                statusColor = "blue";
              } else {
                action = "time-in";
                message = "TIME IN recorded";
                statusColor = "green";
              }
            }

            // âœ… Insert new record
            const { error: insertError } = await supabase.from(TABLE_NAME).insert([
              {
                StudentID: studentId,
                FirstName: firstName,
                MiddleName: middleName,
                LastName: lastName,
                StudentLevel: studentlevel,
                BranchLocation: branchlocation,
                MobileNumber: mobilenum,
                SMSstatus: "pending",
                time_in: new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" }),
                in_out: action,
              },
            ]);

            if (insertError) throw insertError;

            successSound.play().catch(() => {});
            showMessage(fullName, message, statusColor);
          } catch (err) {
            console.error("âŒ Error:", err);
            warnBeep.play();
            statusEl.style.color = "red";
            statusEl.textContent = "Error logging attendance";
          }

          resumeScanning();
        }

        function resumeScanning() {
          isScanningPaused = true;
          setTimeout(() => {
            isScanningPaused = false;
            lastSentQR = "";
            video.style.borderColor = "rgb(248, 248, 248)";
            studentname.textContent = "";
            statusEl.textContent = "Scanning...";
          }, SCAN_PAUSE_MS);
        }

        function showMessage(name, msg, color) {
          video.style.borderColor = color;
          statusEl.style.color = color;
          statusEl.textContent = msg;
          if (studentname) {
            studentname.textContent = name;
            setTimeout(() => {
              if (studentname) studentname.textContent = "";
            }, 2000);
          }
        }
      };
    </script>
  </body>
</html>
