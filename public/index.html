<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="KIEAN_LOGO_Icon.png" type="image/png" />
    <title>Kiean Tutorial Center Attendance</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
      }

      video {
        border: 10px solid rgb(248, 248, 248);
        width: 320px;
        height: 240px;
        margin-top: 0px;
        transition: border-color 0.3s ease;
      }

      #status {
        margin-top: 10px;
        font-weight: bold;
      }

      #qr-content {
        margin-top: 10px;
        color: rgb(230, 17, 17);
        font-weight: bold;
      }

      #esp-ip {
        margin-top: 10px;
        padding: 5px;
        width: 150px;
      }

      label {
        font-weight: bold;
      }
    </style>

    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <div class="main-content">
      <div class="top-div">
        <!-- <img class="logo" src="KIEAN_LOGO.png" alt="ktc"> -->
      </div>

      <div class="qrArea">
        <video id="video" autoplay></video>
        <canvas id="canvas" hidden></canvas>
      </div>

      <div id="studentname"></div>
      <div id="status">Initializing camera...</div>
    </div>

    <script src="jsQR.js"></script>
    <script type="module">
      /* ✅ FIX 1: move imports to top-level */
      import { processQRCodeData } from "./processQR.js";
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      window.onload = async () => {
        // ---- SUPABASE SETUP ----
        const SUPABASE_URL = "https://woqvutbipzimgwicwxzx.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvcXZ1dGJpcHppbWd3aWN3eHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjEwOTcsImV4cCI6MjA3NjEzNzA5N30.DgQyMKQ2C1e6hg9XOjrMkJJ7lqL7r1aJZV50ZoOmj7k";
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const TABLE_NAME = "attendance";

        // ---- ELEMENTS ----
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const statusEl = document.getElementById("status");
        const studentname = document.getElementById("studentname");

        // ---- SOUNDS ----
        const successSound = new Audio("./beepsound.mp3");
        const warnBeep = new Audio("./warnbeep.mp3");

        // ---- SETTINGS ----
        let lastSentQR = "";
        let isScanningPaused = false;
        const SCAN_PAUSE_MS = 1000;

        // ---- CAMERA ----
        navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "environment" } })
          .then((stream) => {
            video.srcObject = stream;
            statusEl.textContent = "Scan a QR code.";
          })
          .catch((err) => {
            console.error(err);
            statusEl.textContent = "Camera access denied!";
          });

        // ---- MAIN LOOP ----
        video.addEventListener("play", () => {
          const scanLoop = () => {
            if (video.paused || video.ended) return;
            if (!isScanningPaused) {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              const imageData = ctx.getImageData(
                0,
                0,
                canvas.width,
                canvas.height
              );
              const code = jsQR(imageData.data, canvas.width, canvas.height);

              if (code && code.data) {
                const qrData = code.data.trim();
                if (qrData !== lastSentQR) {
                  lastSentQR = qrData;
                  handleScan(qrData);
                }
              }
            }
            requestAnimationFrame(scanLoop);
          };
          scanLoop();
        });

        // ---- HANDLE QR SCAN ----
        async function handleScan(qrData) {
          try {
            const parts = processQRCodeData(qrData);
            const [
              studentId,
              firstName,
              middleName,
              lastName,
              studentlevel,
              branchlocation,
              mobilenum,
            ] = parts;

            const fullName = `${firstName} ${middleName} ${lastName}`.trim();

            const { data: existing, error: fetchError } = await supabase
              .from(TABLE_NAME)
              .select("*")
              .eq("StudentID", studentId)
              .order("time_in", { ascending: false })
              .limit(1);

            if (fetchError) throw fetchError;

            let action = "time-in";
            let message = "TIME IN recorded";
            let statusColor = "green";

            if (!existing || existing.length === 0) {
              action = "time-in";
            } else {
              const lastRecord = existing[0];
              if (lastRecord.in_out === "time-in") {
                action = "time-out";
                message = "TIME OUT recorded";
                statusColor = "blue";
              } else if (lastRecord.in_out === "time-out") {
                message = "Already TIMED OUT today";
                statusColor = "red";
                warnBeep.play();
                showMessage(fullName, message, statusColor);
                return;
              }
            }

            console.log("📤 Sending:", action); // ✅ FIX 2: confirm action being sent

            const { data: inserted, error: insertError } = await supabase
              .from(TABLE_NAME)
              .insert([
                {
                  StudentID: studentId,
                  FirstName: firstName,
                  MiddleName: middleName,
                  LastName: lastName,
                  StudentLevel: studentlevel,
                  BranchLocation: branchlocation,
                  MobileNumber: mobilenum,
                  SMSstatus: "pending",
                  time_in: new Date().toLocaleString("en-PH", {
                    timeZone: "Asia/Manila",
                  }),
                  in_out: action, // ✅ FIX 3: ensure this is sent correctly
                },
              ])
              .select();

            if (insertError) throw insertError;

            console.log("✅ Logged:", inserted);
            successSound.play().catch(() => {});
            showMessage(fullName, message, statusColor);
          } catch (err) {
            console.error("❌ Error:", err);
            warnBeep.play();
            statusEl.style.color = "red";
            statusEl.textContent = "Error logging attendance";
          }

          isScanningPaused = true;
          setTimeout(() => {
            isScanningPaused = false;
            lastSentQR = "";
            video.style.borderColor = "rgb(248, 248, 248)";
            statusEl.textContent = "Scanning...";
          }, SCAN_PAUSE_MS);
        }

        function showMessage(name, msg, color) {
          video.style.borderColor = color;
          statusEl.style.color = color;
          statusEl.textContent = msg;
          if (studentname) {
            studentname.textContent = name;
            setTimeout(() => {
              if (studentname) studentname.textContent = "";
            }, 4000);
          }
        }
      };
    </script>
  </body>
</html>
