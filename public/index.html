<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kiean Tutorial Center Attendance</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
  video { border: 10px solid rgb(248, 248, 248); width: 320px; height: 240px; margin-top: 10px; }
  #status { margin-top: 10px; font-weight: bold; }
  #qr-content { margin-top: 10px; color: rgb(230, 17, 17); font-weight: bold; }
  #esp-ip { margin-top: 10px; padding: 5px; width: 150px; }
  label { font-weight: bold; }

</style>
<link rel="stylesheet" href="index.css">
</head>
<body>
<div class="main-content">
  <div class="top-div">
    <img class="logo" src="KIEAN_LOGO.png" alt="ktc">
    <h1>Attendance here!</h1>
  </div>


<div class="espip">
  <label for="esp-ip">ESP IP:</label>
  <input type="text" id="esp-ip" placeholder="192.168.4.1">
</div>

<div class="qrArea">
  <h1 id="studentname"></h1>
<video id="video" autoplay></video>
<canvas id="canvas" hidden></canvas>
</div>
<div id="status">Initializing camera...</div>
<div id="qr-content"></div>
</div>
<script src="jsQR.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");
const qrContentEl = document.getElementById("qr-content");
const espIpEl = document.getElementById("esp-ip");
const studentname = document.getElementById("studentname");

// Track last QR sent to prevent duplicate POSTs for same QR while still in frame
let lastSentQR = "";

// Access camera
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => {
  video.srcObject = stream;
  statusEl.textContent = "Camera ready. Scan a QR code.";
})
.catch(err => {
  console.error(err);
  statusEl.textContent = "Camera access denied!";
});

// Draw rectangle
function drawLine(begin, end, color){
  ctx.beginPath();
  ctx.moveTo(begin.x, begin.y);
  ctx.lineTo(end.x, end.y);
  ctx.lineWidth = 4;
  ctx.strokeStyle = color;
  ctx.stroke();
}

// Scan loop
video.addEventListener("play", () => {
  const scanLoop = () => {
    if(video.paused || video.ended) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);

    if(code) {
      video.style.borderColor = "green";
      studentname.innerText.value="Welcome, " + code.data;
      console.log("Welcome, " + code.data);
      qrContentEl.textContent = code.data;
      statusEl.textContent = "QR Detected!";

      drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
      drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
      drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
      drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");

      // Only send once per QR appearance
      if(code.data !== lastSentQR){
        lastSentQR = code.data;

        const espIp = espIpEl.value.trim();
        if(espIp){
          fetch(`http://${espIp}/scanned`, {
  method: "POST",
  headers: {"Content-Type": "application/x-www-form-urlencoded"},
  body: `qrdata=${encodeURIComponent(code.data)}`
})
.then(res => res.text())
.then(resText => console.log("ESP Response:", resText))
.catch(err => {
  console.error("Failed to reach ESP:", err);
});
        }
      }
    } else {
      video.style.borderColor = "rgb(248, 248, 248)";
      statusEl.textContent = "Scanning...";
      qrContentEl.textContent = "";
      lastSentQR = ""; // Reset when no QR detected to allow next scan
    }

    requestAnimationFrame(scanLoop);
  };
  scanLoop();
});
</script>

</body>
</html>
